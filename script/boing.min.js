"use strict";function onWindowResize(){renderer.setSize(window.innerWidth,window.innerHeight),camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix()}function onDocumentMouseClick(e){var a=new THREE.Vector3(2*e.clientX/window.innerWidth-1,1-2*e.clientY/window.innerHeight,.5),l=new THREE.Raycaster;l.setFromCamera(a.clone(),camera);var n=l.intersectObjects(balls);if(n.length>0){var o=n[0].object,t=a.unproject(camera).sub(camera.position).normalize(),r=new THREE.Ray(camera.position,t).closestPointToPoint(o.position).sub(o.position).normalize().multiplyScalar(o.r),i=t.multiplyScalar(mouseImpulse),s=new THREE.Vector3(0,0,0);impulseBall(o,r,i,s),sound2.play()}}function calculateWallVisability(){for(var e=0;e<walls.length;e++){var a=walls[e];a.visible=!0,camera.position.clone().sub(a.position).dot(a.normal)>0&&(a.visible=!1)}}function init(){addEventListener("resize",onWindowResize,!1),sound1=new Howl({urls:["static/bounce1.ogg","static/bounce1.mp4"]}),sound2=new Howl({urls:["static/bounce2.ogg","static/bounce2.mp4"]}),scene=new THREE.Scene,renderer=new THREE.WebGLRenderer({antialias:!0}),renderer.setSize(window.innerWidth,window.innerHeight),renderer.setClearColor(11184810,1),renderer.shadowMapEnabled=!0,renderer.shadowMapType=THREE.PCFSoftShadowMap;var e=renderer.domElement;e.addEventListener("click",onDocumentMouseClick,!1),e.addEventListener("mousemove",calculateWallVisability,!1),e.addEventListener("touchmove",calculateWallVisability,!1),e.addEventListener("mousewheel",calculateWallVisability,!1),document.body.appendChild(e),camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,.1,1e3),camera.position.z=22;for(var a=new THREE.SphereGeometry(radius,2*sphereDetail,sphereDetail),l=document.getElementById("ballVertexShader").textContent,n=document.getElementById("ballFragmentShader").textContent,o=function(e){return new THREE.ShaderMaterial({uniforms:{color:{type:"c",value:new THREE.Color(e)}},vertexShader:l,fragmentShader:n})},t=[new o(12845619),new o(40811),new o(34749),new o(16765696)],r=0;numberOfBalls>r;r++){var i=new THREE.Mesh(a,t[r%4]);i.position.set(2.5*(3-r)-3.75,2.5*(3-r)-3.75,2.5*(3-r)-3.75),i.v=new THREE.Vector3(.03,0,0),i.rotation.z=Math.PI/8,i.w=new THREE.Vector3(0,.2*(2*(r%2)-1),0),i.r=radius,i.m=1,i.a=2/3,i.I=i.a*i.m*i.r*i.r,i.mp=i.a*i.m/(1+i.a),i.castShadow=!0,balls.push(i),scene.add(i)}var s=new THREE.SpotLight(16777215,1,0,Math.PI/2,1);s.position.set(0,21,0),s.castShadow=!0,s.onlyShadow=!0,s.shadowCameraNear=s.position.y-6.1,s.shadowCameraFar=s.position.y+6.1,s.shadowCameraFov=45,s.shadowDarkness=.4,s.shadowMapWidth=2048,s.shadowMapHeight=2048,scene.add(s);var c=new THREE.PlaneBufferGeometry(23,23),d=new THREE.MeshBasicMaterial({color:11184810}),m=new THREE.Mesh(c,d);m.rotation.x=-Math.PI/2,m.position.y=-6.01,m.receiveShadow=!0,scene.add(m);var u=new THREE.OrbitControls(camera,renderer.domElement);u.noPan=!0,u.minDistance=5,u.maxDistance=30,u.maxPolarAngle=Math.PI/2+.1;var p=function(e,a){var l=new THREE.GridHelper(Math.round(a),1);l.setColors(11141290,11141290),l.material.transparent=!0,l.material.opacity=.6,l.normal=e,l.distance=a,l.position.copy(e.clone().multiplyScalar(a)),l.quaternion.copy((new THREE.Quaternion).setFromUnitVectors(l.up,l.normal)),l.receiveShadow=!0,walls.push(l),scene.add(l)};p(new THREE.Vector3(0,-1,0),6),p(new THREE.Vector3(0,1,0),6),p(new THREE.Vector3(-1,0,0),6),p(new THREE.Vector3(1,0,0),6),p(new THREE.Vector3(0,0,-1),6),p(new THREE.Vector3(0,0,1),6),calculateWallVisability()}function updateBall(e,a){e.position.add(gravity.clone().multiplyScalar(.5*controls.Gravity).add(e.v).multiplyScalar(a)),e.v.add(gravity.clone().multiplyScalar(controls.Gravity*a));var l=(new THREE.Quaternion).setFromAxisAngle(e.w.clone().normalize(),e.w.lengthSq()*a);e.quaternion.copy(l.multiply(e.quaternion))}function updatePhysics(){for(var e=controls.Speed,a=0;numberOfBalls>a;a++)updateBall(balls[a],e);for(var l=0;l<walls.length;l++)for(var n=walls[l].normal,a=0;numberOfBalls>a;a++)e*balls[a].v.dot(n)>0&&n.clone().multiplyScalar(balls[a].r).add(balls[a].position).dot(n)>walls[l].distance&&collideWall(balls[a],walls[l]);for(var o=0;numberOfBalls-1>o;o++)for(var t=o+1;numberOfBalls>t;t++){var r=balls[o].position.distanceToSquared(balls[t].position),i=(balls[o].r+balls[t].r)*(balls[o].r+balls[t].r);if(i>=r){var s=balls[t].position.clone().sub(balls[o].position),c=balls[t].v.clone().sub(balls[o].v);e*s.dot(c)<0&&collideBalls(balls[o],balls[t])}}}function collideWall(e,a){var l=a.normal,n=l.clone().multiplyScalar(e.r),o=e.v.clone().add(e.w.clone().cross(n)),t=l.clone().multiplyScalar(l.dot(o)),r=t.clone().multiplyScalar(-(1+controls["e_n Wall"])*e.m),i=t.sub(o).multiplyScalar((1+controls["e_t Wall"])*e.mp),s=r.add(i),c=l.clone().multiplyScalar(-l.dot(e.w)*(1+controls["e_a Wall"])*e.I);impulseBall(e,n,s,c)}function collideBalls(e,a){var l=a.position.clone().sub(e.position).normalize(),n=l.clone().multiplyScalar(e.r),o=l.clone().multiplyScalar(-a.r),t=e.v.clone().add(e.w.clone().cross(n)),r=a.v.clone().add(a.w.clone().cross(o)),i=l.clone().multiplyScalar(l.dot(t)),s=l.clone().multiplyScalar(l.dot(r)),c=e.m*a.m/(e.m+a.m),d=e.mp*a.mp/(e.mp+a.mp),m=e.I*a.I/(e.I+a.I),u=s.clone().sub(i).multiplyScalar((1+controls["e_n Ball"])*c),p=r.sub(s).sub(t.sub(i)).multiplyScalar((1+controls["e_t Ball"])*d),w=u.add(p),E=l.clone().multiplyScalar((l.dot(a.w)-l.dot(e.w))*(1+controls["e_a Ball"])*m);impulseBall(e,n,w,E),impulseBall(a,o,w.negate(),E.negate()),sound1.play()}function impulseBall(e,a,l,n){e.v.add(l.clone().divideScalar(e.m)),e.w.add(a.clone().cross(l).add(n).divideScalar(e.I))}function updateFps(e){frames++,e-oldTime>1e3&&(fps=Math.round(1e3*frames/(e-oldTime)),oldTime=e,frames=0),controls.FPS=Math.min(60,fps)}function animate(e){requestAnimationFrame(animate),updatePhysics(),updateFps(e),renderer.render(scene,camera)}var balls=[],walls=[],camera,renderer,scene,sound1,sound2,oldTime=0,frames=0,fps=0,sphereDetail=32,numberOfBalls=4,radius=1,mouseImpulse=.1,gravity=new THREE.Vector3(0,-.01,0),controls={FPS:30,Gravity:.1,Speed:1};controls["e_n Wall"]=1,controls["e_t Wall"]=-1,controls["e_a Wall"]=-1,controls["e_n Ball"]=1,controls["e_t Ball"]=1,controls["e_a Ball"]=1,window.onload=function(){var e=new dat.GUI;e.close(),e.add(controls,"FPS",0,60).listen(),e.add(controls,"Gravity",0,.5),e.add(controls,"Speed",-2,2).step(.1)},init(),animate();